name: Update uBlacklist subscription weekly

on:
  schedule:
    - cron: "0 16 * * 1"
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '>=1.17.0'

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: Merge txt
      run: |
        git submodule update --remote --recursive --force
        # 预处理一些数据
        cp source/gyli/Blocklist/BLOCKLIST_uBlacklist source/gyli/Blocklist/blocklist.txt
        rm uBlacklist.txt
        rm uBlocklist.txt
        rm tools/uBlacklist_backup.txt
        rm source/gyli/Blocklist/blocklist.txt
        rm source/Paxxs/Google-Blocklist/data -rf
        rm source/laylavish/uBlockOrigin-HUGE-AI-Blocklist/additional_list_nuclear.txt
        rm source/laylavish/uBlockOrigin-HUGE-AI-Blocklist/list.txt
        rm source/laylavish/uBlockOrigin-HUGE-AI-Blocklist/list_uBlacklist_nuclear.txt
        rm source/laylavish/uBlockOrigin-HUGE-AI-Blocklist/noai_hosts.txt
        mv reverse_url.txt tools/reverse_url

        # Issue # 48
        sed -i '/^http:\/\//d' source/zweie/some-rules-for-ublacklist/Annoyingbastard.txt

        # Issue # 63
        perl -i -pe 's#\Q/.*\/(?:m|wap)\..*/##g' source/zweie/some-rules-for-ublacklist/Annoyingbastard.txt
        sed -i '$a\/.*\/(?:(?!m\.douban\.com)(?:m|wap)\..*/' source/zweie/some-rules-for-ublacklist/Annoyingbastard.txt

        # 合并所有列表
        find . -type f -name "*.txt" -exec sh -c 'cat "$0"; echo' {} \; > tools/uBlacklist

        cd tools
        mv uBlacklist uBlacklist.txt
        go run main.go
        cat -s uBlacklist.txt | sed '/^[[:space:]]*$/d'
        mv uBlacklist.txt ../uBlacklist.txt -f
        cd ..

        # 删除以 # 开头的行
        sed -i '/^#/d' uBlacklist.txt

        # 删除以 ! 开头的行
        sed -i '/^!/d' uBlacklist.txt

        cat tools/reverse_url >> uBlacklist.txt

        # （可选）如果您不需要在文件开头添加时间戳注释，请保留下一行的注释状态；
        # 如果需要添加时间戳，请取消注释。
        # sed -i "1i\! Update weekly at $(TZ=UTC-8 date +'%Y-%m-%d %T %z')" uBlacklist.txt

        # 去除空行
        sed -i '/^$/d' uBlacklist.txt

        # ==== 新增：移除所有包含 csdn.net 的屏蔽规则（如 *://blog.csdn.net/*、||csdn.net^ 等）====
        sed -i '/csdn\.net/d' uBlacklist.txt
        # ======================================================================================

        ln -s uBlacklist.txt uBlocklist.txt

        # 获取当前时间存入环境变量（用于提交信息）
        echo "CURRENT_TIME=$(TZ=UTC-8 date +'%Y-%m-%d %T %z')" >> $GITHUB_ENV

    - name: Commit files
      uses: EndBug/add-and-commit@v9
      with:
        message: "ci(build): update weekly at ${{ env.CURRENT_TIME }}"
        committer_name: 'github-actions[bot]'
        committer_email: 'github-actions[bot]@users.noreply.github.com'
        add: |
          'uBlacklist.txt'
          'tools/uBlacklist_backup.txt'
